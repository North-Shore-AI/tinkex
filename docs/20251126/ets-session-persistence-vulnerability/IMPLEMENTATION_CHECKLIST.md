# Implementation Checklist: ETS Session Persistence Fixes

**Related:** [FINDINGS.md](./FINDINGS.md)

---

## Priority 1: Validate Sessions on Load (CRITICAL)

**File:** `lib/tinkex/session_manager.ex`
**Function:** `load_sessions_from_ets/0` (lines 215-229)

- [ ] Add `validate_session_on_load/2` function
- [ ] Check `Process.whereis(config.http_pool)` returns a pid
- [ ] Log warning for discarded sessions
- [ ] Delete invalid sessions from ETS
- [ ] Add unit test: `test "discards sessions with dead pool on load"`

**Acceptance Criteria:**
```elixir
# After SessionManager restart with dead pool:
refute Map.has_key?(get_sessions(), stale_session_id)
assert :ets.lookup(:tinkex_sessions, stale_session_id) == []
```

---

## Priority 2: Pool Health Check Before Heartbeat (HIGH)

**File:** `lib/tinkex/session_manager.ex`
**Function:** `send_heartbeat/3` (lines 162-177)

- [ ] Add pool existence check before `safe_heartbeat/3`
- [ ] Return `{:error, :pool_not_alive}` if pool missing
- [ ] Log warning at first failure (not just after 120s)
- [ ] Add unit test: `test "heartbeat skips session with dead pool"`

**Acceptance Criteria:**
```elixir
# With dead pool:
assert capture_log(fn -> send(manager, :heartbeat) end) =~ "pool not alive"
# No crash, no Finch request attempted
```

---

## Priority 3: Session Invalidation After Failures (MEDIUM)

**File:** `lib/tinkex/session_manager.ex`
**Function:** heartbeat result handling

- [ ] Add `failure_count` field to session entry
- [ ] Add `@max_consecutive_failures` config (default: 10)
- [ ] Add `@max_failure_duration_ms` config (default: 600_000)
- [ ] Remove session when threshold exceeded
- [ ] Log removal reason
- [ ] Add unit test: `test "removes session after max failures"`

**Acceptance Criteria:**
```elixir
# After 10 consecutive failures:
refute Map.has_key?(get_sessions(), failing_session_id)
assert capture_log(...) =~ "removing session"
```

---

## Priority 4: Supervision Strategy (MEDIUM)

**File:** `lib/tinkex/application.ex`
**Function:** `start/2` (line 36)

**Option A: Change to `:rest_for_one`**
- [ ] Change `strategy: :one_for_one` to `strategy: :rest_for_one`
- [ ] Ensure child order has Finch before SessionManager
- [ ] Document trade-off (Finch restart causes SessionManager restart)

**Option B: Add Process Monitoring**
- [ ] Monitor `http_pool` pid in `SessionManager.init/1`
- [ ] Handle `{:DOWN, ...}` message
- [ ] Invalidate affected sessions on pool death
- [ ] Add unit test: `test "invalidates sessions when pool dies"`

**Choose one option based on team preference.**

---

## Priority 5: Improved Logging & Telemetry (MEDIUM)

**Files:** `lib/tinkex/session_manager.ex`, potentially new `lib/tinkex/telemetry.ex`

- [ ] Add info-level logging for session create/stop
- [ ] Add telemetry events:
  - `[:tinkex, :session, :start]`
  - `[:tinkex, :session, :stop]`
  - `[:tinkex, :heartbeat, :success]`
  - `[:tinkex, :heartbeat, :failure]`
- [ ] Document telemetry events in README or docs

---

## Priority 6: Configurable ETS Table Name (LOW)

**Files:** `lib/tinkex/application.ex`, `lib/tinkex/session_manager.ex`

- [ ] Add config option `:sessions_table`
- [ ] Default to `:tinkex_sessions`
- [ ] Use config value instead of hardcoded atom
- [ ] Add test helper to use unique table per test
- [ ] Update test setup to configure unique table

**Acceptance Criteria:**
```elixir
# In test_helper.exs or setup:
Application.put_env(:tinkex, :sessions_table, :"test_sessions_#{System.unique_integer()}")
# Tests run in parallel without ETS cross-contamination
```

---

## Testing Checklist

### Unit Tests to Add

- [ ] `test "discards sessions with dead pool on load"`
- [ ] `test "heartbeat skips session with dead pool"`
- [ ] `test "removes session after max consecutive failures"`
- [ ] `test "removes session after max failure duration"`
- [ ] `test "invalidates sessions when pool dies"` (if Option B)
- [ ] `test "logs warning for invalid sessions on load"`

### Integration Tests to Add

- [ ] `test "survives pool crash and restart"`
- [ ] `test "survives session manager crash and restart"`
- [ ] `test "handles config change between restarts"`

### Manual Testing

- [ ] Start app, create sessions, kill Finch, observe logs
- [ ] Start app, create sessions, kill SessionManager, observe session state
- [ ] Run full test suite with `--trace` and without, compare warnings

---

## Documentation Updates

- [ ] Update README with session lifecycle behavior
- [ ] Document telemetry events
- [ ] Add troubleshooting section for "unknown registry" errors
- [ ] Document supervision strategy choice and rationale

---

## Review Checklist

Before merging:

- [ ] All new tests pass
- [ ] Existing tests still pass
- [ ] No new warnings in test output
- [ ] Dialyzer passes (if used)
- [ ] Code reviewed by team member
- [ ] CHANGELOG updated
